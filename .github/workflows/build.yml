---
# Github Actions build for rclone (Custom & Clean)
# Include: Linux x64, Linux ARM64, Windows x64, Android
# Exclude: Tests, Lint, Other OS

name: build

on:
  push:
    branches:
      - '**'
    tags:
      - '**'
  pull_request:
  workflow_dispatch:
    inputs:
      manual:
        description: Manual run
        type: boolean
        default: true

jobs:
  # -------------------------------------------------------------------------
  # JOB 1: DESKTOP & SERVER (Linux x64, Linux ARM64, Windows x64)
  # -------------------------------------------------------------------------
  build:
    if: inputs.manual || (github.repository == 'rclone/rclone' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name))
    timeout-minutes: 60
    name: Build ${{ matrix.name }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- LINUX X64 (Standard) ---
          - name: linux-amd64
            goos: linux
            goarch: amd64
            ext: ''
            
          # --- LINUX ARM64 (Aarch64 - Raspberry Pi / Oracle ARM) ---
          - name: linux-arm64
            goos: linux
            goarch: arm64
            ext: ''

          # --- WINDOWS X64 ---
          - name: windows-amd64
            goos: windows
            goarch: amd64
            ext: '.exe'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.24'
          check-latest: true

      - name: Build Rclone (${{ matrix.name }})
        run: |
          # Impostiamo le variabili per la cross-compilazione
          export GOOS=${{ matrix.goos }}
          export GOARCH=${{ matrix.goarch }}
          export CGO_ENABLED=0
          
          # Calcoliamo una versione fittizia se non c'è tag
          VERSION="v1.74.0-custom"
          
          echo "Building for $GOOS/$GOARCH..."
          
          # Compilazione ottimizzata (senza debug info per file più piccoli)
          go build -v -trimpath -ldflags "-s -w -X github.com/rclone/rclone/fs.Version=${VERSION}" -o rclone${{ matrix.ext }} .

      - name: Check Version (Solo se compatibile con runner)
        if: matrix.goarch == 'amd64' && matrix.goos == 'linux'
        run: ./rclone version

      - name: Upload Artifact (${{ matrix.name }})
        uses: actions/upload-artifact@v4
        with:
          name: rclone-${{ matrix.name }}
          path: rclone${{ matrix.ext }}

  # -------------------------------------------------------------------------
  # JOB 2: ANDROID (Tutte le architetture)
  # -------------------------------------------------------------------------
  android:
    if: inputs.manual || (github.repository == 'rclone/rclone' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name))
    timeout-minutes: 30
    name: Build Android
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.24'

      - name: Set global environment variables
        run: |
          echo "VERSION=$(make version)" >> $GITHUB_ENV

      - name: Install Gomobile tools
        run: |
          go install golang.org/x/mobile/cmd/gobind@latest
          go install golang.org/x/mobile/cmd/gomobile@latest
          env PATH=$PATH:~/go/bin gomobile init
          echo "RCLONE_NDK_VERSION=21" >> $GITHUB_ENV

      # --- ARM v7a ---
      - name: Build Android ARMv7a
        run: |
          export CC=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi${RCLONE_NDK_VERSION}-clang
          export CC_FOR_TARGET=$CC
          export GOOS=android
          export GOARCH=arm
          export GOARM=7
          export CGO_ENABLED=1
          export CGO_LDFLAGS="-fuse-ld=lld -s -w"
          go build -v -tags android -trimpath -ldflags "-s -X github.com/rclone/rclone/fs.Version=${VERSION}" -o build/rclone-android-${RCLONE_NDK_VERSION}-armv7a .

      # --- ARM64 v8a ---
      - name: Build Android ARM64
        run: |
          export CC=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${RCLONE_NDK_VERSION}-clang
          export CC_FOR_TARGET=$CC
          export GOOS=android
          export GOARCH=arm64
          export CGO_ENABLED=1
          export CGO_LDFLAGS="-fuse-ld=lld -s -w"
          go build -v -tags android -trimpath -ldflags "-s -X github.com/rclone/rclone/fs.Version=${VERSION}" -o build/rclone-android-${RCLONE_NDK_VERSION}-armv8a .

      # --- x86 ---
      - name: Build Android x86
        run: |
          export CC=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android${RCLONE_NDK_VERSION}-clang
          export CC_FOR_TARGET=$CC
          export GOOS=android
          export GOARCH=386
          export CGO_ENABLED=1
          export CGO_LDFLAGS="-fuse-ld=lld -s -w"
          go build -v -tags android -trimpath -ldflags "-s -X github.com/rclone/rclone/fs.Version=${VERSION}" -o build/rclone-android-${RCLONE_NDK_VERSION}-x86 .

      # --- x64 ---
      - name: Build Android x64
        run: |
          export CC=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android${RCLONE_NDK_VERSION}-clang
          export CC_FOR_TARGET=$CC
          export GOOS=android
          export GOARCH=amd64
          export CGO_ENABLED=1
          export CGO_LDFLAGS="-fuse-ld=lld -s -w"
          go build -v -tags android -trimpath -ldflags "-s -X github.com/rclone/rclone/fs.Version=${VERSION}" -o build/rclone-android-${RCLONE_NDK_VERSION}-x64 .
 
      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rclone-android-all
          path: build/rclone-android-*
